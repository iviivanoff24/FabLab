<th:block xmlns:th="http://www.thymeleaf.org" th:fragment="siteHeader(active)">
  <header class="sticky-top border-bottom">
    <nav class="navbar navbar-expand-lg p-0" style="background-color: var(--header-bg); backdrop-filter: blur(10px);">
      <div class="container flex-wrap py-2">
        
        <!-- 1. LOGO (Top Left) -->
        <a class="navbar-brand d-flex align-items-center p-0 me-0" href="/">
            <img src="/img/logo.png" alt="Logo FabLab Mérida" width="50" height="50" class="me-2" />
            <div class="fw-bold lh-1 text-dark" style="font-size: 1rem;">FabLab<br /><span class="text-secondary">Mérida</span></div>
        </a>

        <!-- 2. TOGGLER (Mobile Right) -->
        <button class="navbar-toggler border-0 ms-auto d-lg-none p-2" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation" style="transition: transform 0.2s;">
            <span class="navbar-toggler-icon" style="filter: var(--navbar-toggler-filter); width: 1.5em; height: 1.5em;"></span>
        </button>

        <!-- 3. AUTH (Desktop Top Right) - Hidden on Mobile -->
        <div class="d-none d-lg-flex align-items-start gap-3 ms-auto">
            
            <!-- Theme Toggle -->
            <button class="btn btn-link nav-link p-0 theme-toggle-btn" title="Cambiar tema">
                <i class="bi bi-moon-stars theme-icon" style="font-size: 1.2rem;"></i>
            </button>

            <!-- Cart -->
            <a href="/cart" class="nav-link p-0 position-relative" title="Carrito">
                <i class="bi bi-cart" style="font-size: 1.2rem"></i>
                <span th:if="${cartCount > 0}" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.65rem; padding: 0.25em 0.4em;">
                    <span th:text="${cartCount > 99 ? '99+' : cartCount}"></span>
                    <span class="visually-hidden">items</span>
                </span>
            </a>

            <div class="vr mx-2 text-muted"></div>

            <!-- Not Logged In -->
            <th:block th:if="${session.USER_ID == null}">
                <a href="/login" class="btn btn-outline-primary btn-sm rounded-pill px-3 fw-semibold">Acceder</a>
                <a href="/register" class="btn btn-primary btn-sm rounded-pill px-3 fw-semibold">Registro</a>
            </th:block>

            <!-- Logged In -->
            <th:block th:if="${session.USER_ID != null}">
                <div class="dropdown">
                    <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle no-arrow" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 38px; height: 38px; transition: transform 0.2s;">
                            <i class="bi bi-person-fill fs-5"></i>
                        </div>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3 mt-2" aria-labelledby="userDropdown">
                        <li><h6 class="dropdown-header">Mi Cuenta</h6></li>
                        <li><a class="dropdown-item py-2" href="/profile"><i class="bi bi-person-badge me-2 text-primary"></i>Ver Perfil</a></li>
                        <li><a class="dropdown-item py-2" href="/cart"><i class="bi bi-cart me-2 text-primary"></i>Mi Carrito</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form method="post" action="/logout" class="m-0">
                                <button type="submit" class="dropdown-item py-2 text-danger"><i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión</button>
                            </form>
                        </li>
                    </ul>
                </div>
            </th:block>
        </div>

        <!-- 4. COLLAPSE (Row 2 on Desktop, Dropdown on Mobile) -->
        <div class="collapse navbar-collapse w-100" id="navbarContent">
            <!-- NAV LINKS (Left aligned on Desktop Row 2) -->
            <ul class="navbar-nav me-auto nav-underline mt-3 mt-lg-0">
              <li class="nav-item"><a th:classappend="${active}=='home'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/">Inicio</a></li>
              <li class="nav-item"><a th:classappend="${active}=='products'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/products">Productos</a></li>
              <li class="nav-item"><a th:classappend="${active}=='machines'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/machines">Máquinas</a></li>
              <li class="nav-item"><a th:classappend="${active}=='courses'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/courses">Cursos</a></li>
              <li class="nav-item" th:if="${session.USER_ADMIN}"><a th:classappend="${active}=='admin'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/admin/admin">Admin</a></li>
              <li class="nav-item"><a th:classappend="${active}=='readme'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/readme">Cómo funciona</a></li>
            </ul>

            <!-- AUTH (Mobile Only) -->
            <div class="d-lg-none mt-3 pb-3 border-top border-secondary-subtle">
                
                <!-- Theme Toggle -->
                <div class="d-flex align-items-center justify-content-between py-3 px-2">
                    <span class="fw-semibold" style="color: var(--text-color);">Apariencia</span>
                    <button class="btn btn-link nav-link p-0 theme-toggle-btn d-flex align-items-center gap-2">
                        <span class="small text-muted" id="themeLabelMobile">Cambiar</span>
                        <i class="bi bi-moon-stars theme-icon fs-4"></i>
                    </button>
                </div>

                <!-- Not Logged In -->
                <th:block th:if="${session.USER_ID == null}">
                    <div class="d-grid gap-3 px-2">
                        <a href="/login" class="btn btn-outline-primary py-2 fw-semibold rounded-3">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Iniciar sesión
                        </a>
                        <a href="/register" class="btn btn-primary py-2 fw-semibold rounded-3 text-white">
                            <i class="bi bi-person-plus me-2"></i>Registrarse
                        </a>
                        <a href="/cart" class="btn btn-link text-decoration-none text-muted text-start p-0 mt-2">
                            <i class="bi bi-cart me-2"></i>Ver Carrito
                        </a>
                    </div>
                </th:block>

                <!-- Logged In -->
                <th:block th:if="${session.USER_ID != null}">
                    <!-- User Card -->
                    <div class="card border-0 shadow-sm mb-3 mx-2" style="background-color: var(--bg-color);">
                        <div class="card-body p-2">
                            <a href="/profile" class="d-flex align-items-center text-decoration-none p-2 rounded" style="color: var(--text-color);">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 shadow-sm" style="width: 42px; height: 42px;">
                                    <i class="bi bi-person-fill fs-5"></i>
                                </div>
                                <div>
                                    <div class="fw-bold lh-1 mb-1">Mi Cuenta</div>
                                    <div class="small text-muted lh-1">Ver perfil y ajustes</div>
                                </div>
                                <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                            </a>
                        </div>
                    </div>

                    <div class="d-grid gap-2 px-2">
                        <a href="/cart" class="btn btn-outline-secondary border-0 text-start d-flex align-items-center py-2 rounded-3" style="color: var(--text-color); background-color: rgba(0,0,0,0.02);">
                            <i class="bi bi-cart-fill me-3 fs-5 text-primary"></i>
                            <span class="fw-semibold">Mi Carrito</span>
                            <span th:if="${cartCount > 0}" class="badge bg-danger ms-auto rounded-pill" th:text="${cartCount}"></span>
                        </a>
                        
                        <form method="post" action="/logout" class="m-0 mt-2">
                            <button type="submit" class="btn btn-danger w-100 py-2 rounded-3 shadow-sm">
                                <i class="bi bi-power me-2"></i>Cerrar sesión
                            </button>
                        </form>
                    </div>
                </th:block>
            </div>
        </div>
      </div>
    </nav>
  </header>

  <script>
    (function() {
        const themeToggles = document.querySelectorAll('.theme-toggle-btn');
        const themeIcons = document.querySelectorAll('.theme-icon');
        const html = document.documentElement;
        
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        let currentTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
        
        function applyTheme(theme) {
            html.setAttribute('data-theme', theme);
            themeIcons.forEach(icon => {
                if (theme === 'dark') {
                    icon.classList.remove('bi-moon-stars');
                    icon.classList.add('bi-sun-fill');
                } else {
                    icon.classList.remove('bi-sun-fill');
                    icon.classList.add('bi-moon-stars');
                }
            });
        }
        
        applyTheme(currentTheme);
        
        themeToggles.forEach(btn => {
            btn.addEventListener('click', () => {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(currentTheme);
                localStorage.setItem('theme', currentTheme);
            });
        });
    })();
  </script>
  </script>
</th:block>