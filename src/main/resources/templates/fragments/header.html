<th:block xmlns:th="http://www.thymeleaf.org" th:fragment="siteHeader(active)">
  <header class="border-bottom bg-white">
    <div class="container py-2 d-flex justify-content-between align-items-center">
      <!-- LOGO -->
      <div class="d-flex align-items-center">
        <img src="/img/logo.png" alt="Logo FabLab Mérida" width="50" height="50" class="me-2" />
        <div class="fw-bold lh-1">FabLab<br /><span class="text-secondary">Mérida</span></div>
      </div>

      <!-- LOGIN / REGISTER / PROFILE -->
      <div class="d-flex align-items-center gap-3" id="authLinks">
        <a href="/login" class="text-dark text-decoration-none small">Iniciar sesión</a>
        <a href="/register" class="text-dark text-decoration-none small">Registrarse</a>
        <i class="bi bi-search" style="font-size: 1.1rem"></i>
      </div>
    </div>

    <!-- NAV LINKS (DEBAJO DEL LOGO) -->
    <nav class="border-top">
      <div class="container">
        <ul class="nav nav-underline">
          <li class="nav-item"><a th:classappend="${active}=='home'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/">Inicio</a></li>
          <li class="nav-item"><a th:classappend="${active}=='machines'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/machines">Máquinas</a></li>
          <li class="nav-item"><a th:classappend="${active}=='courses'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/courses">Cursos</a></li>
          <li class="nav-item" th:if="${session.USER_ADMIN}"><a th:classappend="${active}=='admin'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/admin/admin">Admin</a></li>
          <li class="nav-item"><a th:classappend="${active}=='readme'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/readme">Cómo funciona</a></li>
        </ul>
      </div>
    </nav>
  </header>
</th:block>

<script>
  // Actualiza los enlaces de auth según sesión (cliente)
  (function(){
    async function renderAuth() {
      try {
        const r = await fetch('/api/session/me', { credentials: 'same-origin' });
        if (!r.ok) return;
        const data = await r.json();
        const auth = document.getElementById('authLinks');
        if (!auth) return;
        if (data.logged) {
          // Mostrar nombre y botón logout
          auth.innerHTML = '';
          const span = document.createElement('span');
          span.className = 'small text-dark';
          span.textContent = data.name || data.email || 'Usuario';
          auth.appendChild(span);

          const sep = document.createElement('span'); sep.className='mx-2'; auth.appendChild(sep);

          const logoutForm = document.createElement('form');
          logoutForm.method = 'post';
          logoutForm.action = '/logout';
          logoutForm.style.display = 'inline';
          const btn = document.createElement('button');
          btn.type = 'submit';
          btn.className = 'btn btn-link small p-0 text-decoration-none';
          btn.textContent = 'Cerrar sesión';
          logoutForm.appendChild(btn);
          auth.appendChild(logoutForm);
        } else {
          // Mostrar login/register
          auth.innerHTML = '<a href="/login" class="text-dark text-decoration-none small">Iniciar sesión</a> <a href="/register" class="text-dark text-decoration-none small ms-2">Registrarse</a> <i class="bi bi-search" style="font-size: 1.1rem"></i>';
        }
      } catch (e) {
        // Si falla, dejar los enlaces por defecto
      }
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', renderAuth); else renderAuth();
  })();
</script>