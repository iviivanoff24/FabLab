<th:block xmlns:th="http://www.thymeleaf.org" th:fragment="siteHeader(active)">
  <header class="border-0">
    <div class="container py-2 d-flex justify-content-between align-items-center">
      <!-- LOGO -->
      <div class="d-flex align-items-center">
        <img src="/img/logo.png" alt="Logo FabLab Mérida" width="50" height="50" class="me-2" />
        <div class="fw-bold lh-1">FabLab<br /><span class="text-secondary">Mérida</span></div>
      </div>

      <!-- LOGIN / REGISTER / PROFILE -->
      <div class="d-flex align-items-center gap-3" id="authLinks">
        
        <!-- Theme Toggle Button -->
        <button id="themeToggle" class="btn btn-link text-dark p-0 me-2" title="Cambiar tema">
            <i class="bi bi-moon-stars" id="themeIcon" style="font-size: 1.2rem;"></i>
        </button>

        <!-- Not Logged In -->
        <th:block th:if="${session.USER_ID == null}">
            <a href="/cart" class="text-dark"><i class="bi bi-cart" style="font-size: 1.1rem"></i></a>
            <a href="/login" class="text-dark text-decoration-none small">Iniciar sesión</a>
            <a href="/register" class="text-dark text-decoration-none small">Registrarse</a>
        </th:block>

        <!-- Logged In -->
        <th:block th:if="${session.USER_ID != null}">
            <a href="/cart" class="text-dark me-3"><i class="bi bi-cart" style="font-size: 1.1rem"></i></a>
                        
            <a href="/profile" class="btn btn-secondary btn-sm" role="button" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Ver mi perfil">
                <i class="bi bi-person"></i>
            </a>
            
            <form method="post" action="/logout" style="display:inline">
                <button type="submit" class="btn btn-outline-secondary btn-sm ms-2">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </form>
        </th:block>
      </div>
    </div>

    <!-- NAV LINKS (DEBAJO DEL LOGO) -->
    <nav class="border-0">
      <div class="container">
        <ul class="nav nav-underline">
          <li class="nav-item"><a th:classappend="${active}=='home'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/">Inicio</a></li>
          <li class="nav-item"><a th:classappend="${active}=='products'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/products">Productos</a></li>
          <li class="nav-item"><a th:classappend="${active}=='machines'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/machines">Máquinas</a></li>
          <li class="nav-item"><a th:classappend="${active}=='courses'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/courses">Cursos</a></li>
          <li class="nav-item" th:if="${session.USER_ADMIN}"><a th:classappend="${active}=='admin'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/admin/admin">Admin</a></li>
          <li class="nav-item"><a th:classappend="${active}=='readme'?' active text-primary fw-semibold'" class="nav-link text-dark" href="/readme">Cómo funciona</a></li>
        </ul>
      </div>
    </nav>
  </header>

  <script>
    (function() {
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const html = document.documentElement;
        
        // 1. Determinar tema inicial
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        let currentTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
        
        // 2. Aplicar tema
        function applyTheme(theme) {
            html.setAttribute('data-theme', theme);
            if (theme === 'dark') {
                themeIcon.classList.remove('bi-moon-stars');
                themeIcon.classList.add('bi-sun-fill');
            } else {
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-stars');
            }
        }
        
        applyTheme(currentTheme);
        
        // 3. Evento Toggle
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(currentTheme);
                localStorage.setItem('theme', currentTheme);
            });
        }
    })();
  </script>
</th:block>

<!-- Script de autenticación eliminado ya que ahora se maneja con Thymeleaf en el servidor -->