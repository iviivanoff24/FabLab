<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fablab</title>
    <link rel="icon" href="img/logo.png" type="image/png" sizes="32x32" />
    <link rel="apple-touch-icon" href="img/logo.png" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/machines.css" /> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  </head>
  <body>
    <div th:replace="~{fragments/header :: siteHeader('machines')}"></div>

    <main class="container mt-4">
      
      <div class="admin-hero has-search">
        <h1>Catálogo de Máquinas</h1>
        <p class="lead">Reserva y utiliza nuestro equipamiento especializado</p>
      </div>
      
      <div class="hero-search-container p-3">
        <div class="machine-search-bar p-0">
          <div class="input-group">
            <input id="machineSearch" class="form-control" type="search" placeholder="Buscar máquinas por nombre..." aria-label="Buscar máquinas">
            <select id="machineStatusFilter" class="form-select" aria-label="Filtrar por estado" style="max-width: 200px;">
                <option value="">Todos los estados</option>
                <option value="Disponible">Disponible</option>
                <option value="En_mantenimiento">En mantenimiento</option>
                <option value="No_disponible">No disponible</option>
            </select>
            <button class="btn btn-action-search" type="button"><i class="bi bi-search"></i> Buscar</button>
          </div>
        </div>
      </div>

      <div th:if="${isAdmin}" class="mb-5 mt-5">
        <div class="card card-add-machine mx-auto" style="max-width: 320px;">
          <a href="/admin/add-machine" class="text-decoration-none">
            <div class="card-body d-flex flex-column align-items-center justify-content-center py-4">
              <i class="bi bi-plus-circle-fill display-4 text-warning mb-2"></i>
              <h5 class="card-title m-0">Añadir Máquina</h5>
            </div>
          </a>
        </div>
      </div>
      
      <div th:if="${#lists.isEmpty(machines)}" class="alert alert-info mt-3">No hay máquinas registradas aún.</div>

      <div class="welcome-card mb-5 machine-card" th:if="${!#lists.isEmpty(machines)}" th:each="m,iterStat : ${machines}" th:attr="data-name=${m.name},data-desc=${m.description},data-status=${m.status != null ? m.status.name() : ''}" th:with="statusName=${m.status != null ? m.status.name() : ''}, statusClass=${statusName == 'En_mantenimiento' ? ' text-bg-warning' : (statusName == 'Disponible' ? ' text-bg-success' : ' text-bg-secondary')}, statusText=${statusName == 'En_mantenimiento' ? 'En mantenimiento' : (statusName == 'Disponible' ? 'Disponible' : (statusName == '' ? 'Sin estado' : statusName))}">
        <div class="row g-5 align-items-center" th:classappend="${!iterStat.even} ? ' flex-lg-row-reverse' : ''">
          <div class="col-lg-8">
            <h1 class="display-5 fw-bold mb-3 title-maker" th:text="${m.name}"></h1>
            <p><span class="badge" th:classappend="${statusClass}" th:text="${statusText}"></span>
            <span class="badge text-bg-primary">€<span th:text="${m.hourlyPrice != null ? #numbers.formatDecimal(m.hourlyPrice,1,2) : '0.00'}"></span>/h</span></p>
            
            <div class="info-panel p-4 rounded-4 mb-5">
                <div class="row g-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-geo-alt-fill text-warning me-2"></i>Descripcion</h5>
                    <div class="col-md-12">
                      <p class="lead text-muted mb-5" th:text="${m.description != null && m.description != '' ? m.description : 'Sin descripción.'}"></p>
                    </div>
                </div>
            </div>
            <div class='d-flex flex-wrap align-items-center gap-2 mt-1'>
              <a th:if="${isAdmin or statusName != 'En_mantenimiento'}" th:href="@{/machines/{id}/reserve(id=${m.id})}" class='btn btn-fablab-action'>
                  <i class="bi bi-calendar-check me-2"></i>Reservar
              </a>
              <button th:if="${!isAdmin and statusName == 'En_mantenimiento'}" class="btn btn-secondary disabled" disabled>
                  <i class="bi bi-tools me-2"></i>En Mantenimiento
              </button>
              
              <a th:if="${isAdmin}" th:href="@{/admin/modify-machine(id=${m.id})}" class='btn btn-primary'><i class='bi bi-pencil-square'></i> Editar</a>
              <form th:if="${isAdmin}" th:id="${'form-delete-machine-' + m.id}" th:action="@{/admin/machines/{id}/delete(id=${m.id})}" method='post' class='d-inline'></form>
              <button th:if="${isAdmin}" type='button' class='btn btn-danger' data-bs-toggle='modal' data-bs-target='#deleteMachineModal' 
              th:data-machine-id="${m.id}" th:data-machine-name="${m.name}"><i class='bi bi-trash'></i> Borrar</button>
            </div>
          </div>

          <div class="col-lg-4 d-flex align-items-center justify-content-center">
            <div class="machine-image-container rounded-4" style="width: 100%; height: 300px; display: flex; align-items: center; justify-content: center;">
                <img th:src="${machineImageUrls[m.id]}" alt="Imagen máquina" class="img-fluid" style="max-height: 100%; max-width: 100%; object-fit: contain;" />
            </div>
          </div>
        </div>
      </div>

      <br />
      
      <div th:if="${isAdmin}" class='modal fade' id='deleteMachineModal' tabindex='-1' aria-labelledby='deleteMachineModalLabel' aria-hidden='true'>
        <div class='modal-dialog'>
          <div class='modal-content'>
            <div class='modal-header'>
              <h1 class='modal-title fs-5' id='deleteMachineModalLabel'>Confirmar borrado de máquina</h1>
              <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Cerrar'></button>
            </div>
            <div class='modal-body'>
              <p>¿Seguro que deseas borrar la máquina <strong id='deleteMachineName'></strong>? Esta acción no se puede deshacer.</p>
            </div>
            <div class='modal-footer'>
              <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Cancelar</button>
              <button type='button' id='confirmDeleteMachineBtn' class='btn btn-danger'>Borrar definitivamente</button>
            </div>
          </div>
        </div>
      </div>
      
    </main>
    <footer class="text-center py-4 text-muted small">
      <div class="container">Proyecto académico — FabLab Mérida. Asignatura: MDAI 2025-26. UEx Mérida</div>
    </footer>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js" defer></script>
    <script th:inline="javascript">
      /*<![CDATA[*/
      document.addEventListener('DOMContentLoaded',function(){
        var modal=document.getElementById('deleteMachineModal');
        if(modal){
          var currentId=null;var nameSpan=document.getElementById('deleteMachineName');
          modal.addEventListener('show.bs.modal',function(ev){var btn=ev.relatedTarget;currentId=btn.getAttribute('data-machine-id');var nm=btn.getAttribute('data-machine-name');nameSpan.textContent=nm||currentId;});
          var confirmBtn=document.getElementById('confirmDeleteMachineBtn');
          if(confirmBtn){confirmBtn.addEventListener('click',function(){if(currentId){var f=document.getElementById('form-delete-machine-'+currentId);if(f){f.submit();}}});}
        }

        // Filtro de búsqueda cliente para máquinas
        var input = document.getElementById('machineSearch');
        var statusSelect = document.getElementById('machineStatusFilter');
        
        if(input && statusSelect) {
            var normalize = function(s){ return (s||'').toString().toLowerCase().trim(); };
            var cards = function(){ return Array.from(document.querySelectorAll('.machine-card')); };
            
            var applyFilter = function(){
              var q = normalize(input.value);
              var s = statusSelect.value;
              
              cards().forEach(function(card){
                var name = normalize(card.getAttribute('data-name'));
                var desc = normalize(card.getAttribute('data-desc'));
                var status = card.getAttribute('data-status');
                
                var matchName = q === '' || name.indexOf(q) !== -1 || desc.indexOf(q) !== -1;
                var matchStatus = s === '' || status === s;
                
                if (matchName && matchStatus) {
                    card.classList.remove('d-none');
                    card.style.display = ''; 
                } else {
                    card.classList.add('d-none');
                    card.style.display = 'none'; 
                }
              });
            };
            
            input.addEventListener('input', applyFilter);
            statusSelect.addEventListener('change', applyFilter);
        }
      });
      /*]]>*/
    </script>
  </body>
</html>