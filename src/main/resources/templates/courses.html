<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fablab - Cursos</title>
    <link rel="icon" href="img/logo.png" type="image/png" sizes="32x32" />
    <link rel="apple-touch-icon" href="img/logo.png" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/courses.css" /> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  </head>
  <body>
    <div th:replace="~{fragments/header :: siteHeader('courses')}"></div>

    <br />

    <main class="courses-page">
      <div class="container">
        
        <div class="course-hero-title">
          <h2>Catálogo de Cursos</h2>
        </div>

        <div class="course-search-bar">
          <div class="input-group">
            <input id="courseSearch" class="form-control" type="search" placeholder="Buscar cursos por nombre o descripción..." aria-label="Buscar cursos">
            <button class="btn btn-action-search" type="button"><i class="bi bi-search"></i> Buscar</button>
          </div>
        </div>
        
        <div th:if="${isAdmin}" class="mb-5 mt-5"> <div class="card card-add-course mx-auto" style="max-width: 320px;">
            <a href="/admin/courses/new" class="text-decoration-none text-dark">
              <div class="card-body d-flex flex-column align-items-center justify-content-center py-4">
                <i class="bi bi-plus-circle-fill display-4 text-warning mb-2"></i>
                <h5 class="card-title text-dark m-0">Añadir Nuevo Curso</h5>
              </div>
            </a>
          </div>
        </div>

        <div th:if="${#lists.isEmpty(courses)}" class="alert alert-info mt-3">No hay cursos registrados aún.</div>

        <div th:if="${!#lists.isEmpty(courses)}" class="d-flex flex-wrap justify-content-around gap-4">
          
          <div class="card course-card" th:each="c : ${courses}"
            th:attr="data-name=${c.name},data-desc=${c.description}"
            th:with="spotsFull=${c.capacity != null and c.inscriptions.size() >= c.capacity},
                  statusName=${courseStatus[c.id]},
                  statusClass=${statusName == 'Inscrito' ? ' text-bg-info' : (statusName == 'No_disponible' ? ' text-bg-secondary' : (statusName == 'Plazas_completas' ? ' text-bg-danger' : ' text-bg-success'))},
                  statusText=${statusName == 'Inscrito' ? 'Inscrito' : (statusName == 'No_disponible' ? 'No disponible' : (statusName == 'Plazas_completas' ? 'Plazas completas' : 'Disponible'))}">
            
            <div class="card-hero">
              <img th:src="${courseImageUrls[c.id]}" alt="Imagen curso" />
              <h3><span th:text="${c.name}"></span></h3>
            </div>
            
            <div class="card-info">
              <div class="content">
                <p th:text="${c.description != null && c.description != '' ? c.description : 'Sin descripción.'}"></p>
                
                <p class="mb-2"><span class="badge text-bg-primary">€<span th:text="${c.precio != null ? #numbers.formatDecimal(c.precio,1,2) : '0.00'}"></span></span></p>
                
                <div class="d-flex flex-wrap gap-1 mb-3">
                    <span class="badge duration-badge" th:attr="data-start=${c.startDate},data-end=${c.endDate}">
                        <i class="bi bi-calendar-check me-1"></i>
                        Inicio: <span class="start-text" th:text="${c.startDate}"></span> / <span class="duration-text">-</span>
                    </span>
                    <span class="badge" th:classappend="${statusClass}" th:text="${statusText}"></span>
                    <span class="badge" th:classappend="${spotsFull} ? ' text-bg-danger' : ' text-bg-success'">
                        <i class="bi bi-people-fill me-1"></i>
                        Plazas: <span th:text="${c.inscriptions.size()}"></span>/<span th:text="${c.capacity}"></span>
                    </span>
                </div>
                
                <div class='d-flex flex-wrap align-items-center gap-2 mt-auto pt-3 border-top'>
                  <a th:href="@{/courses/{id}(id=${c.id})}" class='btn btn-sm btn-action'>Saber más</a>
                  <a th:if="${isAdmin}" th:href="@{/admin/modify-course(id=${c.id})}" class='btn btn-sm btn-outline-primary'><i class='bi bi-pencil-square'></i> Editar</a>
                    <form th:if="${isAdmin}" th:id="${'form-delete-course-' + c.id}" th:action="@{/admin/courses/{id}/delete(id=${c.id})}" method='post' class='d-inline'></form>
                    <button th:if="${isAdmin}" type='button' class='btn btn-sm btn-outline-danger' data-bs-toggle='modal' data-bs-target='#deleteCourseModal' 
                      th:data-course-id="${c.id}" th:data-course-name="${c.name}"><i class='bi bi-trash'></i> Borrar</button>
                </div>
              </div>
            </div>
            
          </div>
          </div>
        <div th:if="${isAdmin}" class='modal fade' id='deleteCourseModal' tabindex='-1' aria-labelledby='deleteCourseModalLabel' aria-hidden='true'>
          <div class='modal-dialog'>
            <div class='modal-content'>
              <div class='modal-header'>
                <h1 class='modal-title fs-5' id='deleteCourseModalLabel'>Confirmar borrado de curso</h1>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Cerrar'></button>
              </div>
              <div class='modal-body'>
                <p>¿Seguro que deseas borrar el curso <strong id='deleteCourseName'></strong>? Esta acción no se puede deshacer.</p>
              </div>
              <div class='modal-footer'>
                <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Cancelar</button>
                <button type='button' id='confirmDeleteCourseBtn' class='btn btn-danger'>Borrar definitivamente</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js" defer></script>
    <script th:inline="javascript">
    /*<![CDATA[*/
    // Lógica para el modal de borrado (sin cambios)
    document.addEventListener('DOMContentLoaded',function(){
      var modal=document.getElementById('deleteCourseModal');
      if(!modal) return;
      var currentId=null; var nameSpan=document.getElementById('deleteCourseName');
      modal.addEventListener('show.bs.modal',function(ev){ var btn=ev.relatedTarget; currentId=btn.getAttribute('data-course-id'); var nm=btn.getAttribute('data-course-name'); nameSpan.textContent=nm||currentId; });
      var confirmBtn=document.getElementById('confirmDeleteCourseBtn');
      if(confirmBtn){ confirmBtn.addEventListener('click',function(){ if(currentId){ var f=document.getElementById('form-delete-course-'+currentId); if(f){ f.submit(); } } }); }
    });
    // Calcular duración (en días) para badges de cada curso (sin cambios)
    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('.duration-badge').forEach(function(el){
        try{
          var s = el.getAttribute('data-start');
          var e = el.getAttribute('data-end');
          if(!s || !e) { el.querySelector('.duration-text').textContent = '-'; return; }
          var ds = new Date(s);
          var de = new Date(e);
          if(isNaN(ds) || isNaN(de)) { el.querySelector('.duration-text').textContent = '-'; return; }
          // contamos días completos inclusivos
          var diff = Math.round((de - ds) / (1000*60*60*24)) + 1;
          el.querySelector('.duration-text').textContent = diff + ' días';
        }catch(err){ el.querySelector('.duration-text').textContent = '-'; }
      });
    });

    // Filtro de búsqueda cliente para cursos
    document.addEventListener('DOMContentLoaded', function(){
      var input = document.getElementById('courseSearch');
      if(!input) return;
      var noResults = document.getElementById('noResults'); 
      var cards = function(){ return Array.from(document.querySelectorAll('.course-card')); };
      var normalize = function(s){ return (s||'').toString().toLowerCase().trim(); };
      var applyFilter = function(){
        var q = normalize(input.value);
        var visible = 0;
        cards().forEach(function(card){
          var name = normalize(card.getAttribute('data-name'));
          var desc = normalize(card.getAttribute('data-desc'));
          var match = q === '' || name.indexOf(q) !== -1 || desc.indexOf(q) !== -1;
          card.style.display = match ? '' : 'none';
          if(match) visible++;
        });
      };
      input.addEventListener('input', applyFilter);
    });
    /*]]>*/
    </script>
    <footer class="text-center py-4 text-muted small">
      <div class="container">Proyecto académico — FabLab Mérida. Asignatura: MDAI 2025-26. UEx Mérida</div>
    </footer>
  </body>
</html>