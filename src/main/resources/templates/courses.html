<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fablab</title>
    <link rel="icon" href="img/logo.png" type="image/png" sizes="32x32" />
    <link rel="apple-touch-icon" href="img/logo.png" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/machines.css" />
  </head>
  <body>
    <div th:replace="~{fragments/header :: siteHeader('courses')}"></div>

    <br />

    <main class="machines-page">
      <div class="container">
        <div th:if="${isAdmin}" class="mb-4">
          <div class="card text-bg-warning mb-3 mx-auto" style="max-width: 18rem; max-height: 10rem;">
            <a href="/admin/courses/new" class="text-decoration-none text-dark">
              <div class="card-body d-flex flex-column align-items-center justify-content-center py-3">
                <img src="/img/add.png" alt="Añadir curso" width="48" height="48" class="mb-2" />
                <h5 class="card-title text-dark m-0">Nuevo Curso</h5>
              </div>
            </a>
          </div>
        </div>

        <div th:if="${#lists.isEmpty(courses)}" class="alert alert-info mt-3">No hay cursos registrados aún.</div>

        <div th:if="${!#lists.isEmpty(courses)}" class="d-flex flex-wrap gap-4">
          <div class="card" th:each="c : ${courses}"
               th:with="spotsFull=${c.capacity != null and c.inscriptions.size() >= c.capacity}, statusName=${spotsFull ? 'Plazas_completas' : 'Disponible'}, statusClass=${statusName == 'Plazas_completas' ? ' text-bg-secondary' : (statusName == 'Disponible' ? ' text-bg-success' : ' text-bg-secondary')}, statusText=${statusName == 'Plazas_completas' ? 'Plazas completas' : (statusName == 'Disponible' ? 'Disponible' : statusName)}">
            <div class="face face1">
              <div class="content">
                <img th:src="${courseImageUrls[c.id]}" alt="Imagen curso" />
                <h3 th:text="${c.name}"></h3>
              </div>
            </div>
            <div class="face face2">
              <div class="content">
                <p th:text="${c.description != null && c.description != '' ? c.description : 'Sin descripción.'}"></p>
                <p class="mb-1"><span class="badge text-bg-primary">€<span th:text="${c.precio != null ? #numbers.formatDecimal(c.precio,1,2) : '0.00'}"></span></span></p>
                <p class="mb-1">
                  <span class="badge text-bg-primary me-1 duration-badge" th:attr="data-start=${c.startDate},data-end=${c.endDate}">Inicio: <span class="start-text" th:text="${c.startDate}"></span> — <span class="duration-text">-</span></span>
                  <span class="badge" th:classappend="${statusClass} + ' me-1'" th:text="${statusText}"></span>
                  <span class="badge" th:classappend="${spotsFull} ? ' text-bg-danger' : ' text-bg-success'">Plazas: <span th:text="${c.inscriptions.size()}"></span>/<span th:text="${c.capacity}"></span></span>
                </p>
                <div class='d-flex flex-wrap align-items-center gap-2 mt-1'>
                  <a th:href="@{/courses/{id}(id=${c.id})}" class='btn btn-sm btn-light'>Saber más</a>
                    <a th:if="${isAdmin}" th:href="@{/admin/modify-course(id=${c.id})}" class='btn btn-sm btn-outline-primary'><i class='bi bi-pencil-square'></i> Editar</a>
                    <form th:if="${isAdmin}" th:id="${'form-delete-course-' + c.id}" th:action="@{/admin/courses/{id}/delete(id=${c.id})}" method='post' class='d-inline'></form>
                    <button th:if="${isAdmin}" type='button' class='btn btn-sm btn-outline-danger' data-bs-toggle='modal' data-bs-target='#deleteCourseModal' 
                      th:data-course-id="${c.id}" th:data-course-name="${c.name}"><i class='bi bi-trash'></i> Borrar</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- <div th:if="${!#lists.isEmpty(courses)}" class="d-flex flex-wrap gap-4">
          <div class="card" th:each="c : ${courses}">
            <div class="face face1">
              <div class="content">
                <img th:src="${courseImageUrls[c.id]}" alt="Imagen curso" />
                <h3 th:text="${c.name}"></h3>
              </div>
            </div>
            <div class="face face2">
              <div class="content">
                <p th:text="${c.description != null && c.description != '' ? c.description : 'Sin descripción.'}"></p>
                <p class="mb-1"><span class="badge text-bg-primary">€<span th:text="${c.precio != null ? #numbers.formatDecimal(c.precio,1,2) : '0.00'}"></span></span></p>
                <p class="mb-1">Fechas: <span th:text="${c.startDate}"></span> — <span th:text="${c.endDate}"></span></p>
                <p class="mb-1">Plazas: <span th:text="${c.capacity}"></span></p>
                <div class='d-flex flex-wrap align-items-center gap-2 mt-1'>
                    <a th:href="@{/courses/{id}(id=${c.id})}" class='btn btn-sm btn-warning'>Ver</a>
                    <a th:if="${isAdmin}" th:href="@{/admin/modify-course(id=${c.id})}" class='btn btn-sm btn-outline-primary'><i class='bi bi-pencil-square'></i> Editar</a>
                    <form th:if="${isAdmin}" th:id="${'form-delete-course-' + c.id}" th:action="@{/admin/courses/{id}/delete(id=${c.id})}" method='post' class='d-inline'></form>
                    <button th:if="${isAdmin}" type='button' class='btn btn-sm btn-outline-danger' data-bs-toggle='modal' data-bs-target='#deleteCourseModal' 
                      th:data-course-id="${c.id}" th:data-course-name="${c.name}"><i class='bi bi-trash'></i> Borrar</button>
                </div>
              </div>
            </div>
          </div>
        </div> -->

        <div th:if="${isAdmin}" class='modal fade' id='deleteCourseModal' tabindex='-1' aria-labelledby='deleteCourseModalLabel' aria-hidden='true'>
          <div class='modal-dialog'>
            <div class='modal-content'>
              <div class='modal-header'>
                <h1 class='modal-title fs-5' id='deleteCourseModalLabel'>Confirmar borrado de curso</h1>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Cerrar'></button>
              </div>
              <div class='modal-body'>
                <p>¿Seguro que deseas borrar el curso <strong id='deleteCourseName'></strong>? Esta acción no se puede deshacer.</p>
              </div>
              <div class='modal-footer'>
                <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Cancelar</button>
                <button type='button' id='confirmDeleteCourseBtn' class='btn btn-danger'>Borrar definitivamente</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js" defer></script>
    <script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded',function(){
      var modal=document.getElementById('deleteCourseModal');
      if(!modal) return;
      var currentId=null; var nameSpan=document.getElementById('deleteCourseName');
      modal.addEventListener('show.bs.modal',function(ev){ var btn=ev.relatedTarget; currentId=btn.getAttribute('data-course-id'); var nm=btn.getAttribute('data-course-name'); nameSpan.textContent=nm||currentId; });
      var confirmBtn=document.getElementById('confirmDeleteCourseBtn');
      if(confirmBtn){ confirmBtn.addEventListener('click',function(){ if(currentId){ var f=document.getElementById('form-delete-course-'+currentId); if(f){ f.submit(); } } }); }
    });
    // Calcular duración (en días) para badges de cada curso
    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('.duration-badge').forEach(function(el){
        try{
          var s = el.getAttribute('data-start');
          var e = el.getAttribute('data-end');
          if(!s || !e) { el.querySelector('.duration-text').textContent = '-'; return; }
          var ds = new Date(s);
          var de = new Date(e);
          if(isNaN(ds) || isNaN(de)) { el.querySelector('.duration-text').textContent = '-'; return; }
          // contamos días completos inclusivos
          var diff = Math.round((de - ds) / (1000*60*60*24)) + 1;
          el.querySelector('.duration-text').textContent = diff + ' días';
        }catch(err){ el.querySelector('.duration-text').textContent = '-'; }
      });
    });
    /*]]>*/
    </script>
    <footer class="text-center py-4 text-muted small">
      <div class="container">Proyecto académico — FabLab Mérida. Asignatura: MDAI 2025-26. UEx Mérida</div>
    </footer>
  </body>
</html>
