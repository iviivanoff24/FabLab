<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fablab - Cursos</title>
    <link rel="icon" href="img/logo.png" type="image/png" sizes="32x32" />
    <link rel="apple-touch-icon" href="img/logo.png" />
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" href="/css/bootstrap.min.css" />
    <link rel="stylesheet" th:href="@{/css/main.css}" href="/css/main.css" />
    <link rel="stylesheet" th:href="@{/css/courses.css}" href="/css/courses.css" /> 
    <link rel="stylesheet" th:href="@{/css/chat.css}" href="/css/chat.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  </head>
  <body>
    <div th:replace="~{fragments/header :: siteHeader('courses')}"></div>

    <main class="courses-page">
      <div class="container mt-4">
        
        <div class="admin-hero has-search">
          <h1>Catálogo de Cursos</h1>
          <p class="lead">Aprende nuevas habilidades con nuestros talleres</p>
        </div>
        
        <div class="hero-search-container p-3">
          <div class="course-search-bar p-0">
            <div class="input-group">
              <input id="courseSearch" class="form-control" type="search" placeholder="Buscar cursos por nombre o descripción..." aria-label="Buscar cursos">
              <select id="courseStatusFilter" class="form-select" aria-label="Filtrar por estado">
                  <option value="">Todos los estados</option>
                  <option value="Disponible">Disponible</option>
                  <option value="Plazas_completas">Plazas completas</option>
                  <option value="No_disponible">No disponible</option>
                  <option value="Inscrito" th:if="${session.USER_ID != null}">Inscrito</option>
              </select>
              <select id="coursePriceFilter" class="form-select" aria-label="Filtrar por precio">
                  <option value="">Cualquier precio</option>
                  <option value="free">Gratis</option>
                  <option value="paid">De pago</option>
              </select>
              <button class="btn btn-action-search" type="button"><i class="bi bi-search"></i> Buscar</button>
            </div>
          </div>
        </div>
        
        <div th:if="${isAdmin}" class="mb-5 mt-5"> <div class="card card-add-course mx-auto" style="max-width: 320px;">
            <a href="/admin/courses/new" class="text-decoration-none">
              <div class="card-body d-flex flex-column align-items-center justify-content-center py-4">
                <i class="bi bi-plus-circle-fill display-4 text-warning mb-2"></i>
                <h5 class="card-title m-0">Añadir Nuevo Curso</h5>
              </div>
            </a>
          </div>
        </div>

        <div th:if="${#lists.isEmpty(courses)}" class="alert alert-info mt-3">No hay cursos registrados aún.</div>

        <div th:if="${!#lists.isEmpty(courses)}" class="course-grid">
          
          <div class="card course-card h-100" th:each="c : ${courses}"
            th:attr="data-name=${c.name},data-desc=${c.description},data-status=${courseStatus[c.id]},data-price-type=${c.precio == 0 ? 'free' : 'paid'}"
            th:with="spotsFull=${c.capacity != null and c.inscriptions.size() >= c.capacity},
                  statusName=${courseStatus[c.id]},
                  statusClass=${statusName == 'Inscrito' ? ' text-bg-info' : (statusName == 'No_disponible' ? ' text-bg-secondary' : (statusName == 'Plazas_completas' ? ' text-bg-danger' : ' text-bg-success'))},
                  statusText=${statusName == 'Inscrito' ? 'Inscrito' : (statusName == 'No_disponible' ? 'No disponible' : (statusName == 'Plazas_completas' ? 'Plazas completas' : 'Disponible'))}">
            
            <div class="card-hero">
              <img th:src="${courseImageUrls[c.id]}" alt="Imagen curso" loading="lazy" />
              <div class="card-hero-overlay">
                <h3 th:text="${c.name}">Nombre del Curso</h3>
              </div>
            </div>
            
            <div class="card-body d-flex flex-column">
                <div class="mb-3">
                    <p class="card-text text-muted small mb-3" th:text="${c.description != null && c.description != '' ? c.description : 'Sin descripción.'}"></p>
                </div>
                
                <div class="mt-auto">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge rounded-pill text-bg-primary fs-6">
                            <span th:text="${c.precio != null && c.precio > 0 ? #numbers.formatDecimal(c.precio,1,2) + ' €' : 'Gratis'}"></span>
                        </span>
                        <span class="badge rounded-pill" th:classappend="${statusClass}" th:text="${statusText}"></span>
                    </div>

                    <div class="d-flex justify-content-between text-muted small mb-3">
                        <span th:title="|Inicio: ${c.startDate}|">
                            <i class="bi bi-calendar-event me-1"></i><span th:text="${c.startDate}"></span>
                        </span>
                        <span th:title="|Plazas ocupadas: ${c.inscriptions.size()}/${c.capacity}|">
                            <i class="bi bi-people-fill me-1"></i><span th:text="|${c.inscriptions.size()}/${c.capacity}|"></span>
                        </span>
                    </div>
                
                    <div class="d-grid gap-2">
                        <a th:href="@{/courses/{id}(id=${c.id})}" class="btn btn-action fw-bold">
                            Ver Detalles <i class="bi bi-arrow-right-short"></i>
                        </a>
                        
                        <div th:if="${isAdmin}" class="btn-group" role="group">
                            <a th:href="@{/admin/modify-course(id=${c.id})}" class="btn btn-primary btn-sm">
                                <i class="bi bi-pencil-square"></i> Editar
                            </a>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteCourseModal" 
                                th:data-course-id="${c.id}" th:data-course-name="${c.name}">
                                <i class="bi bi-trash"></i> Borrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
          </div>
        </div>
        <div th:if="${isAdmin}" class='modal fade' id='deleteCourseModal' tabindex='-1' aria-labelledby='deleteCourseModalLabel' aria-hidden='true'>
          <div class='modal-dialog'>
            <div class='modal-content'>
              <div class='modal-header'>
                <h1 class='modal-title fs-5' id='deleteCourseModalLabel'>Confirmar borrado de curso</h1>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Cerrar'></button>
              </div>
              <div class='modal-body'>
                <p>¿Seguro que deseas borrar el curso <strong id='deleteCourseName'></strong>? Esta acción no se puede deshacer.</p>
              </div>
              <div class='modal-footer'>
                <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Cancelar</button>
                <button type='button' id='confirmDeleteCourseBtn' class='btn btn-danger'>Borrar definitivamente</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script th:src="@{/js/bootstrap.bundle.min.js}" src="/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/courses.js}" src="/js/courses.js" defer></script>
    
    <!-- Chat Widget -->
    <div th:replace="~{fragments/chat :: chatWidget}"></div>
    <script th:src="@{/js/chat.js}" src="/js/chat.js"></script>

    <footer class="text-center py-4 text-muted small">
      <div class="container">Proyecto académico — FabLab Mérida. Asignatura: MDAI 2025-26. UEx Mérida</div>
    </footer>
  </body>
</html>