<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administración</title>
    <link rel="icon" th:href="@{/img/logo.png}" href="img/logo.png" type="image/png" sizes="32x32" />
    <link rel="apple-touch-icon" th:href="@{/img/logo.png}" href="img/logo.png" />
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" href="/css/bootstrap.min.css" />
    <link rel="stylesheet" th:href="@{/css/main.css}" href="/css/main.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
    <main>
    <div th:replace="~{fragments/header :: siteHeader('admin')}"></div>

    <div class="container mt-4">
        <div class="admin-hero">
            <h1>Panel de Administración</h1>
            <p>Bienvenido al panel de administración. Aquí podrás ver las tablas importantes de la base de datos.</p>
        </div>

        <!-- Nav tabs -->
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">Usuarios</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="machines-tab" data-bs-toggle="tab" data-bs-target="#machines" type="button" role="tab">Máquinas</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">Productos</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button" role="tab">Reservas</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="shifts-tab" data-bs-toggle="tab" data-bs-target="#shifts" type="button" role="tab">Turnos</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="courses-tab" data-bs-toggle="tab" data-bs-target="#courses" type="button" role="tab">Cursos</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="inscriptions-tab" data-bs-toggle="tab" data-bs-target="#inscriptions" type="button" role="tab">Inscripciones</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="receipts-tab" data-bs-toggle="tab" data-bs-target="#receipts" type="button" role="tab">Recibos</button></li>
        </ul>

        <div class="tab-content border p-3" id="adminTabsContent">
            <div class="tab-pane fade show active" id="users" role="tabpanel">
                <h5>Usuarios</h5>
                <div th:if="${#lists.isEmpty(users)}" class="alert alert-info">No hay usuarios.</div>
                <div class="mb-2 d-flex">
                    <input type="search" class="form-control form-control-sm table-search" placeholder="Buscar usuarios..." data-target="users" />
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 table-search-clear" data-target="users">Limpiar</button>
                </div>
                <div th:if="${!#lists.isEmpty(users)}" class="table-responsive">
                    <table class="table table-sm admin-table" data-entity="users">
                        <thead><tr><th>ID</th><th>Nombre</th><th>Email</th><th>Admin</th><th>Fecha registro</th><th>Acciones</th></tr></thead>
                        <tbody>
                                <tr th:each="u : ${users}" th:attr="data-admin=${u.admin}">
                                <td th:text="${u.id}"></td>
                                <td th:text="${u.name}"></td>
                                <td th:text="${u.email}"></td>
                                <td th:text="${u.admin}"></td>
                                <td th:text="${#temporals.format(u.fechaRegistro,'yyyy-MM-dd')}"></td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a th:href="@{'/admin/modify-user?id=' + ${u.id}}" class="btn btn-outline-secondary">Editar</a>
                                        <form th:action="@{'/admin/users/' + ${u.id} + '/role'}" method="post" style="display:inline">
                                            <input type="hidden" name="admin" th:value="${!u.admin}" />
                                            <button type="submit" class="btn btn-outline-secondary" title="Cambiar rol">Rol</button>
                                        </form>
                                        <button type="button" class="btn btn-outline-danger btn-delete" th:attr="data-action=@{'/admin/users/{id}/delete'(id=${u.id})}, data-entity='usuario', data-id=${u.id}" title="Borrar">Borrar</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="machines" role="tabpanel">
                <h5>Máquinas</h5>
                <div th:if="${#lists.isEmpty(machines)}" class="alert alert-info">No hay máquinas.</div>
                <div class="mb-2 d-flex">
                    <input type="search" class="form-control form-control-sm table-search" placeholder="Buscar máquinas..." data-target="machines" />
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 table-search-clear" data-target="machines">Limpiar</button>
                </div>
                <div th:if="${!#lists.isEmpty(machines)}" class="table-responsive">
                    <table class="table table-sm admin-table" data-entity="machines">
                        <thead><tr><th>ID</th><th>Nombre</th><th>Ubicación</th><th>Estado</th><th>Precio/h</th><th>Acciones</th></tr></thead>
                        <tbody>
                                <tr th:each="m : ${machines}" th:attr="data-status=${m.status}">
                                <td th:text="${m.id}"></td>
                                <td th:text="${m.name}"></td>
                                <td th:text="${m.location}"></td>
                                <td th:text="${m.status}"></td>
                                <td th:text="${#numbers.formatDecimal(m.hourlyPrice,1,2)}"></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{'/admin/modify-machine?id=' + ${m.id}}" class="btn btn-outline-secondary">Editar</a>
                                        <button type="button" class="btn btn-outline-danger btn-delete" th:attr="data-action=@{'/admin/machines/{id}/delete'(id=${m.id})}, data-entity='máquina', data-id=${m.id}">Borrar</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="products" role="tabpanel">
                <h5>Productos</h5>
                <div class="mb-3">
                    <a href="/admin/add-product" class="btn btn-sm btn-primary">Añadir Producto</a>
                </div>
                <div th:if="${#lists.isEmpty(products)}" class="alert alert-info">No hay productos.</div>
                <div class="mb-2 d-flex">
                    <input type="search" class="form-control form-control-sm table-search" placeholder="Buscar productos..." data-target="products" />
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 table-search-clear" data-target="products">Limpiar</button>
                </div>
                <div th:if="${!#lists.isEmpty(products)}" class="table-responsive">
                    <table class="table table-sm admin-table" data-entity="products">
                        <thead><tr><th>ID</th><th>Nombre</th><th>Tipo</th><th>Descripción</th><th>Acciones</th></tr></thead>
                        <tbody>
                                <tr th:each="p : ${products}">
                                <td th:text="${p.id}"></td>
                                <td th:text="${p.name}"></td>
                                <td th:text="${p.type}"></td>
                                <td th:text="${p.description}"></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{'/admin/modify-product?id=' + ${p.id}}" class="btn btn-outline-secondary">Editar</a>
                                        <form action="/admin/products/delete" method="post" style="display:inline" onsubmit="return confirm('¿Borrar producto?');">
                                            <input type="hidden" name="id" th:value="${p.id}">
                                            <button type="submit" class="btn btn-outline-danger">Borrar</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="bookings" role="tabpanel">
                <h5>Reservas</h5>
                <div th:if="${#lists.isEmpty(bookings)}" class="alert alert-info">No hay reservas.</div>
                <div class="mb-2 d-flex">
                    <input type="search" class="form-control form-control-sm table-search" placeholder="Buscar reservas..." data-target="bookings" />
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 table-search-clear" data-target="bookings">Limpiar</button>
                </div>
                <div th:if="${!#lists.isEmpty(bookings)}" class="table-responsive">
                    <table class="table table-sm admin-table" data-entity="bookings">
                        <thead><tr><th>ID</th><th>Usuario</th><th>Turno</th><th>Máquina</th><th>Fecha reserva</th><th>Acciones</th></tr></thead>
                        <tbody>
                                <tr th:each="b : ${bookings}" th:attr="data-estado=${b.estado}">
                                    <td th:text="${b.id}"></td>
                                <td th:text="${b.user != null ? b.user.name : ''}"></td>
                                <td th:text="${b.shift != null ? (b.shift.startTime + ' · ' + b.shift.date) : ''}"></td>
                                <td th:text="${b.shift != null && b.shift.machine != null ? b.shift.machine.name : ''}"></td>
                                <td th:text="${#temporals.format(b.fechaReserva,'yyyy-MM-dd')}"></td>
                                <td><button type="button" class="btn btn-outline-danger btn-delete" th:attr="data-action=@{'/admin/bookings/{id}/delete'(id=${b.id})}, data-entity='reserva', data-id=${b.id}">Borrar</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="shifts" role="tabpanel">
                <h5>Turnos</h5>
                <div th:if="${#lists.isEmpty(shifts)}" class="alert alert-info">No hay turnos.</div>
                <div class="mb-2 d-flex">
                    <input type="search" class="form-control form-control-sm table-search" placeholder="Buscar turnos..." data-target="shifts" />
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 table-search-clear" data-target="shifts">Limpiar</button>
                </div>
                <div th:if="${!#lists.isEmpty(shifts)}" class="table-responsive">
                    <table class="table table-sm admin-table" data-entity="shifts">
                        <thead><tr><th>ID</th><th>Máquina</th><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Estado</th><th>Acciones</th></tr></thead>
                        <tbody>
                                <tr th:each="s : ${shifts}" th:attr="data-status=${s.status}">
                                    <td th:text="${s.id}"></td>
                                <td th:text="${s.machine != null ? s.machine.name : ''}"></td>
                                <td th:text="${#temporals.format(s.date,'yyyy-MM-dd')}"></td>
                                <td th:text="${s.startTime}"></td>
                                <td th:text="${s.endTime}"></td>
                                <td th:text="${s.status}"></td>
                                <td><button type="button" class="btn btn-outline-danger btn-delete" th:attr="data-action=@{'/admin/shifts/{id}/delete'(id=${s.id})}, data-entity='turno', data-id=${s.id}">Borrar</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="courses" role="tabpanel">
                <h5>Cursos</h5>
                <div th:if="${#lists.isEmpty(courses)}" class="alert alert-info">No hay cursos.</div>
                <div class="mb-2 d-flex">
                    <input type="search" class="form-control form-control-sm table-search" placeholder="Buscar cursos..." data-target="courses" />
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 table-search-clear" data-target="courses">Limpiar</button>
                </div>
                <div th:if="${!#lists.isEmpty(courses)}" class="table-responsive">
                    <table class="table table-sm admin-table" data-entity="courses">
                        <thead><tr><th>ID</th><th>Nombre</th><th>Descripción</th><th>Precio</th><th>Acciones</th></tr></thead>
                        <tbody>
                                <tr th:each="c : ${courses}" th:attr="data-estado=${c.estado}">
                                    <td th:text="${c.id}"></td>
                                <td th:text="${c.name}"></td>
                                <td th:text="${c.description}"></td>
                                <td th:text="${#numbers.formatDecimal(c.precio,1,2)}"></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{'/admin/modify-course?id=' + ${c.id}}" class="btn btn-outline-secondary">Editar</a>
                                        <button type="button" class="btn btn-outline-danger btn-delete" th:attr="data-action=@{'/admin/courses/{id}/delete'(id=${c.id})}, data-entity='curso', data-id=${c.id}">Borrar</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="inscriptions" role="tabpanel">
                <h5>Inscripciones</h5>
                <div th:if="${#lists.isEmpty(inscriptions)}" class="alert alert-info">No hay inscripciones.</div>
                <div class="mb-2 d-flex">
                    <input type="search" class="form-control form-control-sm table-search" placeholder="Buscar inscripciones..." data-target="inscriptions" />
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 table-search-clear" data-target="inscriptions">Limpiar</button>
                </div>
                <div th:if="${!#lists.isEmpty(inscriptions)}" class="table-responsive">
                    <table class="table table-sm admin-table" data-entity="inscriptions">
                        <thead><tr><th>ID</th><th>Curso</th><th>Usuario</th><th>Fecha</th><th>Acciones</th></tr></thead>
                        <tbody>
                                <tr th:each="i : ${inscriptions}" th:attr="data-estado=${i.estado}">
                                    <td th:text="${i.id}"></td>
                                    <td th:text="${i.course != null ? i.course.name : ''}"></td>
                                    <td th:text="${i.user != null ? i.user.name : ''}"></td>
                                    <td th:text="${#temporals.format(i.date,'yyyy-MM-dd')}"></td>
                                <td><button type="button" class="btn btn-outline-danger btn-delete" th:attr="data-action=@{'/admin/inscriptions/{id}/delete'(id=${i.id})}, data-entity='inscripción', data-id=${i.id}">Borrar</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="receipts" role="tabpanel">
                <h5>Recibos</h5>
                <div th:if="${#lists.isEmpty(receipts)}" class="alert alert-info">No hay recibos.</div>
                <div class="mb-2 d-flex">
                    <input type="search" class="form-control form-control-sm table-search" placeholder="Buscar recibos..." data-target="receipts" />
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 table-search-clear" data-target="receipts">Limpiar</button>
                </div>
                <div th:if="${!#lists.isEmpty(receipts)}" class="table-responsive">
                    <table class="table table-sm admin-table" data-entity="receipts">
                        <thead><tr><th>ID</th><th>Usuario</th><th>Concepto</th><th>Curso</th><th>Máquina</th><th>Método pago</th><th>Importe</th><th>Fecha</th><th>Acciones</th></tr></thead>
                        <tbody>
                                <tr th:each="r : ${receipts}" th:attr="data-status=${r.estadoRecibo}, data-method=${r.metodoPago}">
                                <td th:text="${r.id}"></td>
                                <td th:text="${r.user != null ? r.user.name : ''}"></td>
                                <td th:text="${r.concepto != null ? r.concepto : ''}"></td>
                                <td th:text="${r.course != null ? (r.course.id + ' · ' + r.course.name) : ''}"></td>
                                <td th:text="${r.machine != null ? (r.machine.id + ' · ' + r.machine.name) : ''}"></td>
                                <td th:text="${r.metodoPago != null ? r.metodoPago : ''}"></td>
                                <td th:text="${#numbers.formatDecimal(r.totalPrice,1,2)}"></td>
                                <td th:text="${#temporals.format(r.fechaEmision,'yyyy-MM-dd')}"></td>
                                <td>
                                    <form th:action="@{/admin/receipts/{id}/status(id=${r.id})}" method="post" class="d-flex gap-1 align-items-center">
                                        <select name="status" class="form-select form-select-sm" style="width:auto;">
                                            <option th:each="st : ${T(com.uex.fablab.data.model.ReceiptStatus).values()}" th:value="${st}" th:text="${st}" th:selected="${st.name() == r.estadoRecibo.name()}"></option>
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-outline-primary">Cambiar</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Confirm modal for destructive actions -->
        <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar acción</h5>
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Cerrar">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p id="confirmMessage">¿Estás seguro?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <form id="confirmForm" method="post" style="display:inline">
                            <button type="submit" class="btn btn-danger">Sí, borrar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </main>
</div>
<footer class="text-center py-4 text-muted small">
      <div class="container">Proyecto académico — FabLab Mérida. Asignatura: MDAI 2025-26. UEx Mérida</div>
    </footer>
<script th:src="@{/js/bootstrap.bundle.min.js}" src="/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/admin/admin-common.js}" src="/js/admin/admin-common.js" defer></script>
<script th:src="@{/js/admin/admin-tables.js}" src="/js/admin/admin-tables.js" defer></script>
</body>
</html>
